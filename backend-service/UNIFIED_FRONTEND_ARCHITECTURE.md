# Unified Frontend Architecture for BTC Yield Protocol

## 🎯 Unified Frontend

 **Extend the existing Wagmi frontend** (`evm-dapp`) to facilitate both EVM and Bitcoin operations through a **unified interface** that communicates with the enhanced backend service.

```
┌─────────────────────────────────────────────────────────────┐
│                    Unified Frontend                        │
│                  (evm-dapp + Bitcoin)                      │
├─────────────────────────────────────────────────────────────┤
│ • MetaMask Integration (EVM transactions)                  │
│ • Bitcoin Core Integration (Bitcoin signing)             │
│ • Unified Loan Dashboard                                   │
│ • Cross-Chain Status Tracking                              │
│ • Single Authentication Flow                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                Enhanced Backend Service                     │
├─────────────────────────────────────────────────────────────┤
│ • Loan Orchestration Engine                                │
│ • EVM Event Monitor                                        │
│ • Cross-Chain State Synchronizer                           │
│ • Bitcoin Transaction Coordinator                          │
│ • Error Recovery Service                                   │
│ • Monitoring & Alerting                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Python API                              │
├─────────────────────────────────────────────────────────────┤
│ • Bitcoin Transaction Creation                             │
│ • Lender Key Management                                    │
│ • Transaction Broadcasting                                 │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 **Unified User Flow**

### **1. Loan Request Flow**
```
Borrower → Unified Frontend → Backend Service → Python API
    ↓
1. Borrower connects MetaMask (or some EVM wallet) to the Loan dapp front end.
2. Borrower starts a local python-api and wallet enabled bitcoin core node. 
  * Aside: Borrower does NOT connect any Bitcoin browser wallet to the UI (no UniSat, Leather, Xverse, etc.)! These (currently) do not work very well in regtest mode or with sequential signing flow needed here. 
3. Borrower computes escrow address using python-api and sends coins to it.
4. Borrower fills loan request form
5. Frontend displays Bitcoin `create-collateral` transaction for signing.
6. Borrower signs using python-api's `borrower-signing` endpoint (running locally on borrower's machine since it uses their private key)
7. Borrower uploads json file created by the python-api vaultero-service to the UI 
8. Frontend sends signature to backend
9. Backend coordinates with lender for completion of the witness (which will happen later, once Borrower reveals their secret preimage on the EVM chain, when 
accepting a loan. The lender will also add their signature to the witness stack).
```

### **2. Loan Offer & Activation Flow**
```
Lender → Unified Frontend → Backend Service → Python API
    ↓
1. Lender sees loan request in dashboard
2. Lender verifies that escrow output exists (consistent with expected p2tr_0 generated by python-api), and that it has apprppriate value for collateral, origination fee and bitcoin mining fees. 
3. After verification, Lender extends loan offer via EVM contract

```

## 🛠️ **Technical Implementation**

### **Frontend Extensions**

#### **1. Bitcoin Core RPC Integration**

**No external Bitcoin wallets** (UniSat, Xverse, Leather, etc.) are used. Instead:

- **Borrowers**: Use local Bitcoin Core wallet via Python API
- **Lenders**: Use backend Bitcoin Core wallet via Python API  
- **Frontend**: Communicates with Python API for Bitcoin operations
- **Signing**: Done locally with private keys, signatures uploaded as JSON files

#### **2. Unified Loan Dashboard**

```typescript
// Enhanced loan component with Bitcoin integration
export function LoanDashboard() {
  const { account } = useAccount() // EVM wallet
  const { bitcoinAccount, signBitcoinTransaction } = useBitcoinWallet()
  const [loans, setLoans] = useState<Loan[]>([])
  
  // Fetch loans with cross-chain status
  const { data: loanData } = useQuery({
    queryKey: ['loans', account?.address],
    queryFn: () => fetchLoansWithBitcoinStatus(account?.address)
  })
  
  return (
    <div className="loan-dashboard">
      <WalletStatus 
        evmWallet={account} 
        bitcoinWallet={bitcoinAccount} 
      />
      
      {loans.map(loan => (
        <LoanCard 
          key={loan.id}
          loan={loan}
          onSignBitcoinTransaction={signBitcoinTransaction}
          onSignEVMTransaction={signEVMTransaction}
        />
      ))}
    </div>
  )
}
```

#### **3. Cross-Chain Status Tracking**

```typescript
// Real-time status updates
export function LoanStatus({ loanId }: { loanId: string }) {
  const [status, setStatus] = useState<LoanStatus>('loading')
  
  // WebSocket connection for real-time updates
  useEffect(() => {
    const ws = new WebSocket(`ws://localhost:3001/loans/${loanId}/status`)
    
    ws.onmessage = (event) => {
      const update = JSON.parse(event.data)
      setStatus(update.status)
    }
    
    return () => ws.close()
  }, [loanId])
  
  return (
    <div className="loan-status">
      <EVMStatus status={status.evm} />
      <BitcoinStatus status={status.bitcoin} />
      <CrossChainSync status={status.sync} />
    </div>
  )
}
```

### **Backend API Extensions**

#### **1. Bitcoin Transaction Endpoints**

```typescript
// New backend endpoints for Bitcoin operations
app.post('/api/bitcoin/transactions/escrow', async (req, res) => {
  const { loanId, borrowerPubkey, amount } = req.body
  
  // Create escrow transaction via Python API
  const escrowTx = await pythonApi.createEscrowTransaction({
    loanId,
    borrowerPubkey,
    amount
  })
  
  res.json({
    success: true,
    data: {
      transactionId: escrowTx.id,
      rawTransaction: escrowTx.rawTx,
      escrowAddress: escrowTx.escrowAddress,
      signingInstructions: escrowTx.signingInstructions
    }
  })
})

app.post('/api/bitcoin/signatures', async (req, res) => {
  const { loanId, transactionId, signature, signerType } = req.body
  
  // Store signature and coordinate with other party
  const result = await signatureService.storeSignature({
    loanId,
    transactionId,
    signature,
    signerType
  })
  
  res.json({
    success: true,
    data: result
  })
})
```

#### **2. Cross-Chain Status API**

```typescript
// Real-time status endpoint
app.get('/api/loans/:loanId/status', async (req, res) => {
  const { loanId } = req.params
  
  const status = await loanOrchestration.getLoanStatus(loanId)
  
  res.json({
    success: true,
    data: {
      evm: status.evm,
      bitcoin: status.bitcoin,
      crossChain: status.crossChain,
      workflow: status.workflow
    }
  })
})

// WebSocket for real-time updates
app.ws('/loans/:loanId/status', (ws, req) => {
  const { loanId } = req.params
  
  // Subscribe to loan status changes
  const unsubscribe = loanOrchestration.subscribeToLoanStatus(loanId, (status) => {
    ws.send(JSON.stringify(status))
  })
  
  ws.on('close', unsubscribe)
})
```

## 🔐 **Security Model**

### **Bitcoin Key Management**
- **Borrower Keys**: NEVER stored in backend, always kept in user's Bitcoin wallet
- **Lender Keys**: Managed by Python API service (platform operator)
- **Signature Workflow**: Separate signing with secure transmission

### **Authentication Flow**
```
1. User connects MetaMask (EVM authentication)
2. User connects Bitcoin wallet (Bitcoin authentication)
3. Frontend creates session linking both wallets
4. Backend validates both wallet connections
5. All subsequent operations use session-based auth
```

## 📱 **User Experience**

### **Single Dashboard View**
```
┌─────────────────────────────────────────────────────────────┐
│                    Loan Dashboard                          │
├─────────────────────────────────────────────────────────────┤
│ 🔗 Wallets Connected:                                      │
│   ✅ MetaMask (0x1234...) - EVM                            │
│   ✅ UniSat (bc1p...) - Bitcoin                            │
│                                                             │
│ 📋 Active Loans:                                           │
│   ┌─────────────────────────────────────────────────────┐   │
│   │ Loan #1 - $10,000 BTC Collateral                   │   │
│   │ Status: ⏳ Waiting for Bitcoin Signature            │   │
│   │ EVM: ✅ Loan Request Submitted                      │   │
│   │ Bitcoin: ⏳ Escrow Transaction Pending              │   │
│   │ [Sign Bitcoin Transaction] [View Details]           │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 📊 Cross-Chain Status:                                     │
│   ✅ EVM Chain: Connected                                 │
│   ✅ Bitcoin Network: Connected                           │
│   ✅ Backend Service: Healthy                             │
└─────────────────────────────────────────────────────────────┘
```

### **Unified Transaction Flow**
```
1. User initiates loan request
2. Frontend shows single form with both EVM and Bitcoin fields
3. User signs EVM transaction (MetaMask popup)
4. Frontend automatically requests Bitcoin transaction from backend
5. User signs Bitcoin transaction (Bitcoin wallet popup)
6. Frontend shows unified status with both chains
7. Real-time updates as loan progresses
```

## 🚀 **Implementation Phases**

### **Phase 1: Bitcoin Wallet Integration** (Week 1-2)
- [ ] Add Bitcoin wallet connection (UniSat, Xverse)
- [ ] Implement Bitcoin transaction signing
- [ ] Create unified wallet status component
- [ ] Add Bitcoin wallet authentication

### **Phase 2: Backend API Extensions** (Week 3-4)
- [ ] Add Bitcoin transaction endpoints
- [ ] Implement signature workflow API
- [ ] Add cross-chain status tracking
- [ ] Create WebSocket for real-time updates

### **Phase 3: Unified UI Components** (Week 5-6)
- [ ] Create unified loan dashboard
- [ ] Add cross-chain status indicators
- [ ] Implement unified transaction flows
- [ ] Add Bitcoin transaction signing UI

### **Phase 4: Integration & Testing** (Week 7-8)
- [ ] End-to-end testing
- [ ] Cross-chain workflow validation
- [ ] Error handling and recovery
- [ ] Performance optimization

## 🎯 **Key Benefits**

✅ **Single Interface**: Users interact with one unified frontend
✅ **Seamless Experience**: No context switching between applications
✅ **Real-time Updates**: Live status across both EVM and Bitcoin
✅ **Secure**: Bitcoin keys never leave user's wallet
✅ **Scalable**: Easy to add more Bitcoin wallets and EVM chains
✅ **Maintainable**: Single codebase for all frontend functionality

## 🔧 **Technical Considerations**

### **Bitcoin Wallet Support**
- **UniSat Wallet**: Most popular Bitcoin wallet for web3
- **Xverse Wallet**: Multi-chain wallet with Bitcoin support
- **OKX Wallet**: Major exchange wallet with Bitcoin integration
- **Leather Wallet**: Formerly Hiro Wallet, Bitcoin-focused

### **Cross-Chain State Management**
- **Real-time Sync**: WebSocket connections for live updates
- **State Reconciliation**: Automatic detection of inconsistencies
- **Error Recovery**: Graceful handling of cross-chain failures
- **Audit Trail**: Complete logging of all operations

### **Performance Optimization**
- **Lazy Loading**: Load Bitcoin components only when needed
- **Caching**: Cache Bitcoin transaction data and signatures
- **Batch Operations**: Group multiple Bitcoin operations
- **Connection Pooling**: Efficient WebSocket management

This unified architecture provides a **seamless user experience** while maintaining the security model where Bitcoin keys never touch the backend, and all cross-chain coordination is handled transparently by the enhanced backend service.
